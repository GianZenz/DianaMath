{% extends "base.html" %}

{% block content %}
<div class="home-container">
    {% if user %}
    <!-- Logged in user content -->
    <div class="welcome-section">
        <div class="welcome-content">
            <div class="diana-avatar">
                <img src="{{ url_for('static', filename=user.name|user_avatar) }}" alt="{{ user.name }}'s Avatar" class="diana-image">
                <div class="speech-bubble">
                    {% if user.name.lower() == 'diana' %}
                    <p>Hi! I'm ready for math! 🌟</p>
                    {% else %}
                    <p>Hi {{ user.name }}! Let's learn math together! 🌟</p>
                    {% endif %}
                </div>
            </div>
            <div class="welcome-text">
                <h1 class="welcome-title">Welcome back, {{ user.name }}! 🎉</h1>
                <p class="welcome-subtitle">Let's continue your math adventure!</p>
            </div>
        </div>
        
        <div class="user-stats">
            <div class="stat-card">
                <h3>🌟 Your Level</h3>
                <div class="level-number">{{ user.level }}</div>
            </div>
            <div class="stat-card">
                <h3>⭐ Total Points</h3>
                <div class="points-number">{{ user.total_points }}</div>
            </div>
            <div class="stat-card">
                <h3>📚 Primary Year</h3>
                <div class="year-number">Primary {{ user.current_year }}</div>
            </div>
        </div>
    </div>

    <div class="navigation-section">
        <div class="nav-links">
            <a href="/dashboard" class="nav-link">📊 Progress Dashboard</a>
            <a href="/settings" class="nav-link">⚙️ Settings</a>
        </div>
    </div>

    <div class="topics-grid">
        <h2 class="section-title">Choose Your Math Adventure! 🚀</h2>
        
        <div class="topic-cards">
            <a href="/learn/Number and Place Value" class="topic-card number-card">
                <div class="topic-icon">🔢</div>
                <h3>Numbers</h3>
                <p>Count, compare, and understand numbers!</p>
            </a>

            <a href="/learn/Addition and Subtraction" class="topic-card addition-card">
                <div class="topic-icon">➕</div>
                <h3>Addition & Subtraction</h3>
                <p>Add and take away numbers like a pro!</p>
            </a>

            <a href="/learn/Multiplication and Division" class="topic-card multiplication-card">
                <div class="topic-icon">✖️</div>
                <h3>Times & Division</h3>
                <p>Groups, arrays, and sharing fairly!</p>
            </a>

            <a href="/learn/Fractions" class="topic-card fractions-card">
                <div class="topic-icon">🍰</div>
                <h3>Fractions</h3>
                <p>Parts of a whole - like pieces of cake!</p>
            </a>

            <a href="/learn/Measurement" class="topic-card measurement-card">
                <div class="topic-icon">📏</div>
                <h3>Measurement</h3>
                <p>Length, weight, time, and more!</p>
            </a>

            <a href="/learn/Geometry" class="topic-card geometry-card">
                <div class="topic-icon">🔷</div>
                <h3>Shapes</h3>
                <p>Circles, squares, and amazing shapes!</p>
            </a>
        </div>
    </div>

    <div class="motivation-section">
        <div class="motivation-card">
            <h3>🎯 Today's Goal</h3>
            <p>Try to earn 50 more points!</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (user.total_points % 100) }}%"></div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Login form for new users -->
    <div class="login-section">
        <h1 class="welcome-title">Welcome to DianaMath! 🎉</h1>
        <p class="welcome-subtitle">Let's make math fun and exciting!</p>
        
        <div class="login-card">
            <!-- Step 1: Name Entry -->
            <div id="step1" class="login-step">
                <h2>👋 What's your name?</h2>
                <form id="nameForm" class="login-form">
                    <div class="form-group">
                        <label for="name">📝 Enter your name</label>
                        <input type="text" id="name" name="name" placeholder="Type your name here..." required class="name-input">
                    </div>
                    <button type="submit" class="start-button">Next ▶️</button>
                </form>
            </div>

            <!-- Step 2: Year Selection (for new users only) -->
            <div id="step2" class="login-step" style="display: none;">
                <h2>📚 What Primary year are you in?</h2>
                <p class="welcome-new-user">Welcome! Since you're new, we need to know your school year to give you the right math problems.</p>
                <form id="yearForm" action="/login" method="POST" class="login-form">
                    <input type="hidden" id="hiddenName" name="name" value="">
                    <div class="form-group">
                        <label for="current_year">📚 Select your Primary year</label>
                        <select id="current_year" name="current_year" required class="year-select">
                            <option value="">Choose your year...</option>
                            <option value="1">Primary 1</option>
                            <option value="2">Primary 2</option>
                            <option value="3">Primary 3</option>
                            <option value="4">Primary 4</option>
                            <option value="5">Primary 5</option>
                            <option value="6">Primary 6</option>
                            <option value="7">Primary 7</option>
                        </select>
                        <small>This helps us give you the right level of math problems!</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="back-button" onclick="goBackToStep1()">◀️ Back</button>
                        <button type="submit" class="start-button">🚀 Start Learning!</button>
                    </div>
                </form>
            </div>

            <!-- Loading state -->
            <div id="loading" class="login-step" style="display: none;">
                <h2>⏳ Checking...</h2>
                <p>Please wait while we check your account...</p>
            </div>
        </div>
        
        <div class="preview-section">
            <h3>🌟 What you'll learn:</h3>
            <div class="preview-topics">
                <div class="preview-item">🔢 Numbers & Counting</div>
                <div class="preview-item">➕ Addition & Subtraction</div>
                <div class="preview-item">✖️ Multiplication & Division</div>
                <div class="preview-item">🍰 Fractions</div>
                <div class="preview-item">📏 Measurement</div>
                <div class="preview-item">🔷 Shapes & Geometry</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Two-step login functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Add some fun animations when the page loads
        const cards = document.querySelectorAll('.topic-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.animation = 'bounceIn 0.6s ease-out';
            }, index * 100);
        });

        // Handle step 1 form submission (name check)
        const nameForm = document.getElementById('nameForm');
        if (nameForm) {
            nameForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nameInput = document.getElementById('name');
                const name = nameInput.value.trim();
                
                if (!name) {
                    alert('Please enter your name!');
                    return;
                }
                
                // Show loading state
                showStep('loading');
                
                // Check if user exists
                fetch('/check_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'name=' + encodeURIComponent(name)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // Existing user - redirect to home
                        window.location.href = data.redirect;
                    } else {
                        // New user - show step 2
                        document.getElementById('hiddenName').value = name;
                        showStep('step2');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Something went wrong. Please try again.');
                    showStep('step1');
                });
            });
        }
    });

    function showStep(stepId) {
        // Hide all steps
        const steps = document.querySelectorAll('.login-step');
        steps.forEach(step => step.style.display = 'none');
        
        // Show the requested step
        const targetStep = document.getElementById(stepId);
        if (targetStep) {
            targetStep.style.display = 'block';
        }
    }

    function goBackToStep1() {
        showStep('step1');
        // Clear the name input for a fresh start if needed
        // document.getElementById('name').value = '';
    }
</script>
{% endblock %}